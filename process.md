# 系统数据流与处理流程

本文档详细说明系统各模块之间的数据传输、输入输出关系和完整处理流程。

---

## 1. 整体架构数据流

```
┌─────────────┐
│  用户输入   │ "追击敌人"
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│     Interactive_Module (交互界面)           │
│  - 加载 API Key                             │
│  - 初始化 MCP 服务器                        │
│  - 调用 LLM-Agent                           │
└──────────────┬──────────────────────────────┘
               │
               │ tools, execute_fn
               ▼
┌─────────────────────────────────────────────┐
│      LLM_Module (双层LLM核心)               │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │  上层LLM (任务规划)                   │  │
│  │  输入: user_input + tools             │  │
│  │  输出: tasks[step, task, type]        │  │
│  └──────────────┬───────────────────────┘  │
│                 │                            │
│                 │ tasks                      │
│                 ▼                            │
│  ┌──────────────────────────────────────┐  │
│  │  下层LLM (任务执行)                   │  │
│  │  输入: task + previous_result         │  │
│  │  输出: tool_call(name, args)          │  │
│  └──────────────┬───────────────────────┘  │
└─────────────────┼────────────────────────────┘
                  │
                  │ execute_tool_fn(name, args)
                  ▼
┌─────────────────────────────────────────────┐
│     Robot_Module (MCP工具注册中心)          │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │  chase.py (追击模块)                 │  │
│  │  - get_enemy_positions()             │  │
│  │  - chase_enemy(enemy_positions)      │  │
│  └──────────────┬───────────────────────┘  │
│                 │                            │
│  ┌──────────────────────────────────────┐  │
│  │  base.py (底盘控制)                  │  │
│  │  - move_forward(distance, speed)     │  │
│  │  - turn(angle, angular_speed)        │  │
│  │  - stop()                            │  │
│  └──────────────┬───────────────────────┘  │
│                 │                            │
│  ┌──────────────────────────────────────┐  │
│  │  vision.py (视觉检测)                │  │
│  │  - detect_color_and_act(image_path)  │  │
│  └──────────────┬───────────────────────┘  │
└─────────────────┼────────────────────────────┘
                  │
                  │ action = {"action": "...", "parameters": {...}}
                  ▼
┌─────────────────────────────────────────────┐
│       ROS2 Topic Communication              │
│                                              │
│  Topics:                                     │
│  /robot/command       → 动作命令            │
│  /robot/state         → 机器人状态          │
│  /robot/enemies       → 敌人位置            │
│  /robot/enemy_remove  → 清除敌人            │
└─────────────────┬────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│     Sim_Module (2D仿真器)                    │
│                                              │
│  ┌──────────────────────────────────────┐  │
│  │  Robot (机器人)                       │  │
│  │  输入: action                         │  │
│  │  状态: x, y, angle                    │  │
│  └──────────────┬───────────────────────┘  │
│                 │                            │
│  ┌──────────────────────────────────────┐  │
│  │  EnemyManager (敌人管理器)            │  │
│  │  spawn_enemy(x, y)                    │  │
│  │  remove_enemy(id)                     │  │
│  │  get_all_enemies()                    │  │
│  └──────────────┬───────────────────────┘  │
│                 │                            │
│  ┌──────────────────────────────────────┐  │
│  │  Pygame 可视化                        │  │
│  │  - 绘制机器人、敌人、网格             │  │
│  │  - 60 FPS 更新                        │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

---

## 2. 追击功能数据流详解

### 2.1 完整追击流程

```
用户输入: "追击敌人"
        │
        ▼
┌───────────────────────────────────────────────┐
│  LLM_Module.plan_tasks()                      │
│  输入: "追击敌人"                              │
│  输出: [                                       │
│    {"step": 1, "task": "获取敌人位置"},        │
│    {"step": 2, "task": "追击最近的敌人"}       │
│  ]                                             │
└───────────────┬───────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────┐
│  步骤1: get_enemy_positions()                 │
│  ┌─────────────────────────────────────────┐  │
│  │ 1. 初始化 ROS2 订阅器                   │  │
│  │ 2. 等待连接建立 (1.5秒)                 │  │
│  │ 3. 刷新回调 (50次 spin_once)            │  │
│  │ 4. 获取缓存 _cached_enemy_positions     │  │
│  └──────────────┬──────────────────────────┘  │
│                 │                              │
│                 ▼                              │
│  输出: '[{"id":"1","x":100,"y":200}]'        │
└───────────────┬───────────────────────────────┘
                │
                │ previous_result = '[...]'
                ▼
┌───────────────────────────────────────────────┐
│  步骤2: chase_enemy(enemy_positions)          │
│  ┌─────────────────────────────────────────┐  │
│  │ 1. 解析敌人位置 JSON                     │  │
│  │ 2. 获取机器人当前位置                    │  │
│  │ 3. 计算最近敌人                          │  │
│  │ 4. 计算目标角度和旋转角度                │  │
│  │ 5. 发布 turn 命令到 ROS2                 │  │
│  │ 6. 等待旋转完成并验证                    │  │
│  │ 7. 前进（PID控制，自适应角度校正）       │  │
│  │ 8. 到达目标 (< 5像素)                    │  │
│  │ 9. 发布 remove_enemy 命令                │  │
│  │ 10. 等待仿真器更新位置                   │  │
│  └──────────────┬──────────────────────────┘  │
│                 │                              │
│                 ▼                              │
│  输出: {"success": true, "message": "..."}    │
└───────────────────────────────────────────────┘
```

### 2.2 ROS2 话题数据流

#### 发布-订阅关系

```
┌─────────────────────┐         /robot/command          ┌─────────────────────┐
│  Robot_Module       │ ──────────────────────────────► │  Sim_Module         │
│  (ActionPublisher)  │   JSON: {"action": "turn",     │  (ActionSubscriber) │
│                     │          "parameters": {...}}  │                     │
└─────────────────────┘                                    ▲                │
         │                                                   │                │
         │                                                   │                │
         ▼                                                   │                │
┌─────────────────────┐         /robot/state               │                │
│  Sim_Module         │ ◄──────────────────────────────────┘                │
│  (RobotStatePub)    │   JSON: {"x": 400.0, "y": 300.0, "angle": 0.0}     │
└─────────────────────┘                                                      │
         │                                                                     │
         │                                                                     │
         ▼                                                                     │
┌─────────────────────┐         /robot/enemies                                │
│  Sim_Module         │ ──────────────────────────────────────────────►      │
│  (EnemyPosPub)      │   JSON: [{"id": "1", "x": 100, "y": 200}]      │      │
└─────────────────────┘                                                  │    │
         ▲                                                                │    │
         │                                                                │    │
         │  /robot/enemy_remove                                          │    │
┌─────────────────────┐   JSON: {"enemy_id": "1"}                       │    │
│  Robot_Module       │ ◄─────────────────────────────────────────────┘    │
│  (EnemyRemovePub)   │                                                       │
└─────────────────────┘                                                       │
                                                                               │
                                                                               │
  仿真器内部:                                                                  │
  ┌──────────────────────────────────────────────────────────────────────┐   │
  │  update() 循环 (60 FPS)                                              │   │
  │                                                                      │   │
  │  1. robot.update() - 平滑移动                                       │   │
  │  2. enemy_manager.update() - 更新敌人                                │   │
  │  3. publish_robot_state() - 发布机器人状态 (每帧)                    │   │
  │  4. 每180帧 (3秒) → publish_enemy_positions()                       │   │
  │  5. 处理 action_queue.get_nowait() - 执行动作命令                    │   │
  │  6. 处理 enemy_remove_subscriber - 移除敌人 → 立即发布位置更新        │   │
  └──────────────────────────────────────────────────────────────────────┘   │
                                                                               │
                                                                               │
  追击模块内部:                                                                │
  ┌──────────────────────────────────────────────────────────────────────┐   │
  │  get_enemy_positions()                                               │   │
  │  ── [订阅器初始化] 0.5秒等待 ── [刷新回调] 50次 spin_once ── [获取] │   │
  │  缓存                                                                 │   │
  └──────────────────────────────────────────────────────────────────────┘   │
                                                                               │
                                                                               │
  ┌──────────────────────────────────────────────────────────────────────┐   │
  │  chase_enemy(positions)                                               │   │
  │  ── [解析] ── [找最近] ── [计算角度] ── [turn命令] ── [前进循环]    │   │
  │  ── [自适应校正] ── [到达] ── [remove_enemy命令] ── [等待更新]      │   │
  └──────────────────────────────────────────────────────────────────────┘   │
```

---

## 3. 关键数据格式

### 3.1 ROS2 动作命令

```json
// turn 命令
{
  "action": "turn",
  "parameters": {
    "angle": 54.9,
    "angular_speed": 0.5
  }
}

// move_forward 命令
{
  "action": "move_forward",
  "parameters": {
    "distance": 1.0,
    "speed": 0.3
  }
}
```

### 3.2 机器人状态

```json
{
  "x": 355.9,
  "y": 438.1,
  "angle": 357.7
}
```

### 3.3 敌人位置

```json
[
  {"id": "1", "x": 100, "y": 200},
  {"id": "2", "x": 500, "y": 400}
]
```

### 3.4 清除敌人命令

```json
{
  "enemy_id": "1"
}
```

---

## 4. 时序图：追击完整流程

```
用户          Interactive      LLM(规划)      LLM(执行)      Chase        ROS2         Simulator
 │                │               │               │            │            │             │
 │ "追击敌人"     │               │               │            │            │             │
 ├───────────────►│               │               │            │            │             │
 │                │               │               │            │            │             │
 │                │  run_pipeline │               │            │            │             │
 │                ├──────────────►│               │            │            │             │
 │                │               │               │            │            │             │
 │                │               │  plan_tasks() │            │            │             │
 │                │               │  (规划)       │            │            │             │
 │                │               ├──────────────►│            │            │             │
 │                │               │               │            │            │             │
 │                │               │  tasks[       │            │            │             │
 │                │               │   {step:1,    │            │            │             │
 │                │               │    task:"获取  │            │            │             │
 │                │               │     敌人位置"},│            │            │             │
 │                │               │   {step:2,    │            │            │             │
 │                │               │    task:"追击  │            │            │             │
 │                │               │     敌人"}     │            │            │             │
 │                │               │◄──────────────┤            │            │             │
 │                │               │               │            │            │             │
 │                │               │  exec_step1() │            │            │             │
 │                │               ├──────────────►│            │            │             │
 │                │               │               │            │            │             │
 │                │               │               │  get_enemy │            │             │
 │                │               │               │ _positions()│            │             │
 │                │               │               ├───────────►│            │             │
 │                │               │               │            │  订阅+刷新  │             │
 │                │               │               │            ├───────────►│             │
 │                │               │               │            │            │  发布位置    │
 │                │               │               │            │◄───────────┤             │
 │                │               │               │◄───────────┤            │             │
 │                │               │◄──────────────┤            │            │             │
 │                │               │               │            │            │             │
 │                │               │  exec_step2() │  prev_res= │            │             │
 │                │               │  (with prev)  │  "[...]"    │            │             │
 │                │               ├──────────────►│            │            │             │
 │                │               │               │            │            │             │
 │                │               │               │  chase_enemy│            │             │
 │                │               │               │ (positions) │            │             │
 │                │               │               ├───────────►│            │             │
 │                │               │               │            │  发布turn   │             │
 │                │               │               │            ├───────────►│             │
 │                │               │               │            │            │  执行turn    │
 │                │               │               │            │            ├──────────►  │
 │                │               │               │            │  发布state │◄───────────┤
 │                │               │               │            │◄───────────┤             │
 │                │               │               │            │            │             │
 │                │               │               │            │  前进循环... │            │
 │                │               │               │            ├───────────►│             │
 │                │               │               │            │            │  移动机器人  │
 │                │               │               │            │◄───────────┤             │
 │                │               │               │            │            │             │
 │                │               │               │            │  remove_1  │             │
 │                │               │               │            ├───────────►│             │
 │                │               │               │            │            │  删除+发布   │
 │                │               │               │            │◄───────────┤             │
 │                │               │               │            │            │             │
 │                │               │               │◄───────────┤            │             │
 │                │               │◄──────────────┤            │            │             │
 │                │◄──────────────┤               │            │            │             │
 │◄───────────────┤               │               │            │            │             │
 │                │               │               │            │            │             │
```

---

## 5. 角度计算数据流

```
输入: robot_pos(x, y, angle), target(x, y)
      │
      ▼
┌─────────────────────────────────────┐
│  _calculate_target_angle()          │
│  dx = target_x - robot_x            │
│  dy = target_y - robot_y            │
│  angle_rad = atan2(-dy, dx)         │  // 注意屏幕坐标系
│  angle_deg = angle_rad % 360        │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│  _calculate_angle_difference()      │
│  diff = target_angle - current_angle│
│  diff = (diff + 180) % 360 - 180    │  // 标准化到[-180, 180]
│                                      │
│  结果:                               │
│  正值 → 左转                         │
│  负值 → 右转                         │
└─────────────────────────────────────┘
```

---

## 6. 自适应角度校正数据流

```
前进循环中检测距离变化:
      │
      ▼
┌──────────────────────────────────────┐
│  记录 prev_dist                       │
│  计算 current_dist                    │
│                                       │
│  if current_dist > prev_dist:        │  距离增大
│      dist_increase_count++           │
│                                       │
│      if count >= 3:                  │  连续3次
│          重新计算角度                 │
│          if angle_diff > 5°:         │
│              重新旋转                 │
│          else:                       │
│              减小步长                 │
│  else:                               │  距离减小
│      dist_increase_count = 0         │
└──────────────────────────────────────┘
```

---

## 7. 敌人管理数据流

```
Sim_Module update():
      │
      ├─► robot.update()
      │     └─► 平滑移动到 target_x, target_y
      │
      ├─► enemy_manager.update()
      │     └─► 更新所有敌人位置
      │
      ├─► publish_robot_state(x, y, angle)
      │     └─► /robot/state (每帧)
      │
      ├─► if frame_count % 180 == 0:
      │     └─► publish_enemy_positions()
      │           └─► /robot/enemies (每3秒)
      │
      ├─► process_enemy_remove_queue()
      │     └─► remove_enemy(id)
      │           └─► publish_enemy_positions() (立即)
      │
      └─► process_action_queue()
            └─► robot.execute_action(action)
```

---

## 8. 缓存机制

### 8.1 敌人位置缓存

```
_global: _cached_enemy_positions = []

订阅器回调:
  _message_callback(msg):
    _cached_enemy_positions = json.loads(msg.data)

获取函数:
  get_enemy_positions():
    subscriber.spin_once()  # 触发回调
    return _cached_enemy_positions
```

### 8.2 机器人状态缓存

```
_global: _cached_robot_state = None

订阅器回调:
  _message_callback(msg):
    _cached_robot_state = json.loads(msg.data)

获取函数:
  get_robot_state():
    subscriber.spin_once()  # 触发回调
    return _cached_robot_state
```

---

## 9. 懒加载机制

```
Robot_Module 模块:
      │
      ├─► _get_action_queue()
      │     └─► 首次调用时初始化 ROS2 发布者
      │
      └─► _get_vlm_core()
            └─► 首次调用时初始化 VLM 客户端

优势:
  - 避免启动时的依赖问题
  - 按需初始化，减少启动时间
  - 只在实际使用时才创建资源
```

---

## 10. PID 控制数据流

```
输入: current_distance (像素)
      │
      ▼
┌─────────────────────────────────────┐
│  转换: distance_m = pixels / 100    │
│                                     │
│  PID 计算:                          │
│    step = distance_m * 0.8          │  // P项
│    step = min(step, 1.0)            │  // 最大步长
│    step = max(step, 0.1)            │  // 最小步长
│                                     │
│  输出: step_distance (米)           │
└─────────────────────────────────────┘
```

---

## 总结

该系统采用**模块化设计**，通过 **ROS2 话题**实现松耦合通信：

1. **Interactive_Module**: 用户交互入口
2. **LLM_Module**: 任务规划和执行
3. **Robot_Module**: MCP 工具注册和调用
4. **ROS2**: 标准化消息传递
5. **Sim_Module**: 可视化和执行

数据流特点：
- **异步**: 发布-订阅模式
- **缓存**: 全局变量存储最新状态
- **懒加载**: 按需初始化资源
- **自适应**: 实时调整策略（角度校正）
